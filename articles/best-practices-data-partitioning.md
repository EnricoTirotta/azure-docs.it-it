<properties
   pageTitle="Linee guida di partizionamento di dati | Microsoft Azure"
   description="Indicazioni su come separare le partizioni per la gestione e l'accesso separati."
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/28/2015"
   ms.author="masashin"/>

# Linee guida di partizionamento di dati

![](media/best-practices-data-partitioning/pnp-logo.png)

## Panoramica

In molte soluzioni su larga scala, i dati vengono suddivisi in partizioni separate per poter essere gestiti e per poter accedervi separatamente. La strategia di partizionamento deve essere scelta attentamente per ottimizzare le prestazioni riducendo al minimo gli effetti negativi. Il partizionamento può aiutare a migliorare la scalabilità, ridurre i conflitti e ottimizzare le prestazioni. Un vantaggio secondario del partizionamento è dato dal fatto che fornisce un meccanismo per la divisione dei dati per modello di utilizzo; è possibile trovare una soluzione economica di archiviazione per i dati meno recenti e più inattivi (a freddo).

## Perché la partizione di dati?

La maggior parte dei servizi e delle applicazioni cloud archivia e recupera i dati come parte delle loro operazioni. La progettazione degli archivi dati utilizzati da un'applicazione può avere un impatto significativo sulle prestazioni, sulla velocità effettiva e sulla scalabilità di un sistema. Una tecnica comunemente applicata in sistemi di grandi dimensioni consiste nel suddividere i dati in partizioni separate.

> Il termine _partizionamento_ utilizzato in questa guida si riferisce al processo di suddivisione fisica dei dati in archivi dati separati. Questo processo non è identico al partizionamento di una tabella in SQL Server, che è un concetto diverso.

Il partizionamento dei dati può offrire una serie di vantaggi. Ad esempio, può essere applicato al fine di:

- **Migliorare la scalabilità**. L’aumento delle dimensioni del sistema del singolo database raggiungerà un limite hardware fisico. Suddividere i dati tra più partizioni, ognuna delle quali è ospitata in un server separato, consente al sistema una scalabilità orizzontale quasi infinita.
- **Migliorare le prestazioni** Le operazioni di accesso ai dati in ogni partizione vengono eseguite su un volume di dati più piccolo. Questo approccio è molto più efficiente, a condizione che i dati siano partizionati in modo appropriato. Le operazioni che interessano più di una partizione possono eseguire in parallelo. Ogni partizione può essere situata nell'applicazione che la utilizza per ridurre al minimo la latenza di rete.
- **Migliorare la disponibilità**. La separazione dei dati tra più server consente di evitare singoli punti di errore. Se un server fallisce, o è sottoposto a manutenzione pianificata, solo i dati collocati in quella partizione non sono disponibili. Le operazioni su altre partizioni possono continuare. L’aumento del numero di partizioni riduce l'impatto relativo di un singolo errore del server, riducendo la percentuale di dati che non saranno disponibili. Eseguire la replica di ogni partizione permette di ridurre ulteriormente le probabilità di un singolo errore della partizione singola che interessi le operazioni. Consente inoltre la separazione dei dati critici, che devono essere continuamente e a disponibilità elevata, da dati di valore inferiore (ad esempio file di log) con minori requisiti di disponibilità.
- **Migliorare la sicurezza**. A seconda della natura dei dati e della modalità di partizionamento, è possibile separare i dati sensibili e non sensibili in partizioni diverse e, pertanto, in diversi server o archivi dati. La sicurezza può essere ottimizzata in modo specifico per i dati sensibili.
- **Fornire flessibilità operativa**. Il partizionamento offre molte opportunità per operazioni di ottimizzazione, ottimizzazione dell'efficienza amministrativa e riduzione dei costi. Alcuni esempi definiscono diverse strategie per la gestione, il monitoraggio, il backup e il ripristino e altre attività amministrative in base all'importanza dei dati in ogni partizione.
- **Combinare l'archivio dati al modello di utilizzo**. Il partizionamento consente a ogni partizione di essere distribuita in un diverso tipo di archivio dati, basato sul costo e le funzionalità incorporate offerte dall’archivio dati. Ad esempio, dati binari di grandi dimensioni potrebbero essere archiviati in un archivio di dati blob, mentre più dati strutturati potrebbero essere conservati in un database di documenti. Per ulteriori informazioni vedere [Creazione di una soluzione Polyglot](https://msdn.microsoft.com/library/dn313279.aspx) in Indicazioni su modelli e procedure[Accesso ai dati per le soluzioni altamente scalabili mediante l’utilizzo di SQL NoSQL e Polyglot Persistence](https://msdn.microsoft.com/library/dn271399.aspx) del sito Web Microsoft.

Alcuni sistemi non implementano il partizionamento perché viene considerato un overhead anziché un vantaggio. Motivi comuni per questa spiegazione sono:

- Molti sistemi di archiviazione di dati non supportano i join tra le partizioni e può essere difficile mantenere l'integrità referenziale in un sistema partizionato. Spesso è necessario implementare join e controlli di integrità nel codice dell'applicazione (nel livello di partizionamento), che può comportare I/O aggiuntive e la complessità dell'applicazione.
- La gestione delle partizioni non è sempre un compito facile. In un sistema in cui i dati sono volatili, potrebbe essere necessario ribilanciare periodicamente le partizioni per ridurre i conflitti e le aree sensibili.
- Alcuni strumenti comuni non funzionano ovviamente con dati partizionati.

## Progettazione di partizioni

I dati possono essere partizionati in modi diversi: orizzontalmente, verticalmente o dal punto di vista funzionale. La strategia scelta dipende dal motivo del partizionamento dei dati e dai requisiti delle applicazioni e dei servizi che utilizzeranno i dati.

> [AZURE.NOTE]Gli schemi di partizionamento descritti in questa guida sono spiegati in modo indipendente dalla tecnologia di archiviazione dati sottostante. Possono essere applicati a molti tipi di archivi dati, inclusi i database relazionali e NoSQL.

### Strategie di partizionamento

Le tre strategie più comuni per il partizionamento dei dati sono:

- **Il partizionamento orizzontale** (spesso chiamato _sharding_). In questa strategia ogni partizione è un archivio dati indipendente, ma tutte le partizioni hanno lo stesso schema. Ogni partizione è nota come uno _shard_ e contiene un sottoinsieme specifico dei dati, ad esempio tutti gli ordini per un set specifico di clienti in un'applicazione di e-commerce.
- **Il partizionamento verticale**. In questa strategia ogni partizione contiene un sottoinsieme dei campi per gli elementi nell'archivio dati. I campi sono suddivisi in base ai loro modello di utilizzo, ad esempio i campi utilizzati di frequente sono inseriti in una partizione verticale e i campi utilizzati meno di frequente in un'altra.
- **Partizionamento funzionale**. In questa strategia i dati vengono aggregati in base alla loro modalità di utilizzo da parte di ogni contesto limitato nel sistema. Ad esempio, un sistema e-commerce che implementa funzioni separate di business per la fatturazione e la gestione dell’inventario dei prodotti potrebbe archiviare i dati della fattura in una partizione e i dati di inventario del prodotto in un’altra.

È importante notare che le tre strategie descritte di seguito possono essere combinate. Non si escludono a vicenda e potrebbe essere opportuno prenderle tutte in considerazione durante la progettazione di uno schema di partizionamento. Ad esempio, si potrebbe dividere i dati in partizioni e quindi utilizzare il partizionamento verticale per suddividere ulteriormente i dati in ogni partizione. Analogamente, i dati in una partizione funzionale possono essere suddivisi in partizioni (che possono anche essere partizionati verticalmente).

Tuttavia, i diversi requisiti di ogni strategia possono generare un certo numero di conflitti che è necessario valutare e bilanciare durante la progettazione di uno schema di partizionamento che soddisfi tutti gli obiettivi di prestazioni di elaborazione dati del sistema. Nelle sezioni seguenti queste strategie vengono illustrate più in dettaglio.

### Partizionamento orizzontale (sharding)

La figura 1 mostra una panoramica del partizionamento orizzontale o sharding. In questo esempio, i dati di inventario del prodotto sono divisi in partizioni in base alla chiave di prodotto. Ogni partizione contiene i dati per un intervallo contiguo di chiavi di partizione (A-G e H-Z), organizzati in ordine alfabetico.

![](media/best-practices-data-partitioning/DataPartitioning01.png)

_Figura 1. -Partizionamento orizzontale (sharding) dei dati in base a una chiave di partizione_

Il partizionamento orizzontale consente di distribuire il carico su più computer, riducendo i conflitti e migliorando le prestazioni. È possibile scalare orizzontalmente il sistema aggiungendo ulteriori partizioni in esecuzione su altri server.

Il fattore più importante quando si implementa questa strategia di partizionamento è la scelta della chiave di partizionamento orizzontale. Può essere difficile modificare la chiave quando il sistema è in esecuzione. La chiave deve garantire che i dati siano partizionati in modo che il carico di lavoro sia il più possibile uniforme tra le partizioni. Si noti che le diverse partizioni non devono contenere volumi simili di dati: è importante che siano in grado di bilanciare il numero di richieste. Alcune partizioni possono essere di grandi dimensioni, ma ogni elemento è l'oggetto di un numero ridotto di operazioni di accesso, mentre altre partizioni possono essere di dimensioni inferiori, ma ogni elemento viene utilizzato più frequentemente. È inoltre importante garantire che una singola partizione non superi i limiti di scalabilità (in termini di risorse di capacità e di elaborazione) dell'archivio dati utilizzato per ospitare tale partizionamento.

Lo schema di partizionamento deve anche evitare di creare aree sensibili (o partizioni critiche) che possono influire sulle prestazioni e sulla disponibilità. Ad esempio, utilizzare un hash di un identificatore di cliente anziché la prima lettera del nome di un cliente impedirà la distribuzione sbilanciata che risulterebbe dall’utilizzo delle lettere iniziali, comuni e meno comuni. Questa è una tecnica tipica che consente di distribuire i dati in modo più uniforme tra le partizioni.

La chiave di partizionamento scelta dovrebbe ridurre al minimo eventuali esigenze future per suddividere le partizioni di grandi dimensioni in parti più piccole, unire partizioni di piccole dimensioni in partizioni di dimensioni maggiori o modificare lo schema che descrive i dati archiviati in un set di partizioni. Queste operazioni possono richiedere molto tempo e potrebbero richiedere di disconnettere una o più partizioni mentre vengono eseguite. Se le partizioni vengono replicate, è possibile mantenere alcune delle repliche online mentre altre vengono suddivise, unite o riconfigurate, ma il sistema potrebbe richiedere di limitare le operazioni che possono essere eseguite sui dati di tali partizioni durante la riconfigurazione. Ad esempio, i dati nelle repliche potrebbero essere contrassegnati come di sola lettura per limitare l'ambito di eventuali incoerenze che potrebbero altrimenti verificarsi durante la ristrutturazione delle partizioni.

> Per ulteriori informazioni e istruzioni sulla maggior parte di queste considerazioni e tecniche consigliate per la progettazione di archivi dati che implementano il partizionamento orizzontale, vedere il [Modello di partizionamento orizzontale](http://aka.ms/Sharding-Pattern)

### Partizionamento verticale

L'utilizzo più comune per il partizionamento verticale è la riduzione dei costi di I/O e delle prestazioni associati con il recupero degli elementi utilizzati più frequentemente. La figura 2 mostra una panoramica di un esempio di partizionamento verticale, dove proprietà diverse per ogni elemento di dati vengono conservate in diverse partizioni: il nome, la descrizione e le informazioni sui prezzi per i prodotti utilizzati più frequentemente rispetto al volume disponibile o agli ultimi dati ordinati.

![](media/best-practices-data-partitioning/DataPartitioning02.png)

_Figura 2. -Partizionamento dei dati per il modello di utilizzo verticale_

In questo esempio, l'applicazione interroga regolarmente il nome del prodotto, la descrizione e il prezzo insieme quando visualizza i dettagli dei prodotti ai clienti. Poiché la data e il livello disponibile sono due elementi che vengono comunemente utilizzati insieme, quando il prodotto è stato ordinato dal produttore sono stati conservati in una partizione separata. Questo schema di partizionamento offre il vantaggio che i dati relativamente lenti (nome prodotto, descrizione e prezzo) sono separati dai dati più dinamici (livello disponibile e ultima data ordinata). Per un'applicazione può risultare più vantaggioso memorizzare nella cache i dati lenti se sono utilizzati più frequentemente.

Un altro scenario tipico per questa strategia di partizionamento è ottimizzare la sicurezza dei dati sensibili. Ad esempio, archiviando i numeri delle carte di credito e i corrispondenti numeri di verifica di sicurezza delle carte in partizioni separate.

Il partizionamento verticale può inoltre ridurre la quantità di accesso simultaneo richiesta per i dati.

> Il partizionamento verticale opera a livello di entità all'interno di un archivio dati, normalizzando parzialmente un'entità per suddividerla da un elemento _di grandi dimensioni_ a una raccolta di elementi._ristretti_. È particolarmente adatto per gli archivi di dati orientati alla colonna, ad esempio HBase e Cassandra. Se è improbabile modificare i dati in una raccolta di colonne, è possibile utilizzare archivi di colonne in SQL Server.

### Partizionamento funzionale

Per i sistemi in cui è possibile identificare un contesto delimitato per ogni area di attività distinta o per ogni servizio nell'applicazione, il partizionamento funzionale fornisce una tecnica per migliorare le prestazioni di accesso ai dati e di isolamento. Un altro utilizzo comune del partizionamento funzionale è la separazione dei dati di sola scrittura dai dati di sola lettura utilizzati per la creazione di report. La figura 3 mostra una panoramica del partizionamento funzionale in cui i dati di inventario sono separati dai dati del cliente.

![](media/best-practices-data-partitioning/DataPartitioning03.png)

_Figura 3. -Partizionamento funzionale dei dati dal contesto vincolato o sottodominio _

Questa strategia di partizionamento può contribuire a ridurre i conflitti di accesso ai dati in diverse parti del sistema.

## Progettazione di partizioni per la scalabilità

È importante considerare le dimensioni e il carico di lavoro per ogni partizione e bilanciarle in modo che i dati siano distribuiti per ottenere la massima scalabilità. È tuttavia necessario partizionare i dati in modo che non superino i limiti di ridimensionamento della singola partizione di un archivio.

Quando si progettano le partizioni per la scalabilità, attenersi alla seguente procedura:

1. È necessario analizzare l’applicazione per capire i modelli di accesso ai dati, come la dimensione della serie di risultati restituiti da ogni query, la frequenza di accesso, la latenza intrinseca e i requisiti di elaborazione di calcolo sul lato server . In molti casi, è possibile che alcune entità principali richiederanno la maggior parte delle risorse di elaborazione.
2. In base all'analisi, si determineranno gli obiettivi di scalabilità attuali e futuri, ad esempio le dimensioni dei dati e il carico di lavoro e si distribuiranno i dati in tutte le partizioni per soddisfare l'obiettivo di scalabilità. Nella strategia di partizionamento orizzontale è importante scegliere la chiave di partizionamento appropriata per assicurarsi che la distribuzione sia uniforme. Per altre informazioni, vedere il [Modello di partizionamento](http://aka.ms/Sharding-Pattern).
3. È necessario assicurarsi che le risorse disponibili in ogni partizione siano sufficienti per gestire i requisiti di scalabilità in termini di dimensioni dei dati e di velocità. Il nodo che ospita una partizione, ad esempio, potrebbe imporre un limite sulla quantità di spazio di archiviazione, sulla potenza di elaborazione o sulla larghezza di banda di rete che fornisce. Se i requisiti di elaborazione e archiviazione dati rischiano di superare tali limiti potrebbe essere necessario perfezionare la strategia di partizionamento o dividere ulteriormente i dati in uscita. Un approccio di scalabilità, ad esempio, potrebbe essere la separazione dei dati di registrazione dalle funzionalità delle applicazioni principali, utilizzando archivi dati separati per impedire che i requisiti di archiviazione totale dei dati superino il limite di ridimensionamento del nodo. Se il numero totale di archivi dati supera il limite dei nodi, è necessario utilizzare nodi di archiviazione separati.
4. Monitorare il sistema in uso per verificare che i dati siano distribuiti come previsto e che le partizioni siano in grado di gestire il carico imposto. È possibile che l'utilizzo non corrisponda a quello previsto dall'analisi, quindi potrebbe essere necessario ribilanciare le partizioni. In caso contrario, potrebbe essere necessario riprogettare alcune parti del sistema per ottenere il bilanciamento richiesto.

Si noti che alcuni ambienti cloud allocano le risorse in termini di limiti di infrastruttura, ed è necessario assicurarsi che tali limiti forniscano spazio sufficiente per qualsiasi crescita anticipata del volume di dati, in termini di archiviazione dei dati, potenza di elaborazione e larghezza di banda. Ad esempio, se si utilizza l’archiviazione tabelle di Azure, una partizione occupata potrebbe richiedere più risorse rispetto a quelli disponibili per una singola partizione per gestire le richieste (esiste un limite per il volume di richieste che possono essere gestite da una singola partizione in un determinato periodo di tempo, vedere la pagina [Obiettivi di scalabilità e prestazioni per Archiviazione di Azure](https://msdn.microsoft.com/library/azure/dn249410.aspx) sul sito Web Microsoft per ulteriori dettagli). In questo caso, il partizionamento deve essere suddiviso in partizioni per ripartire il carico. Se la dimensione totale o la velocità effettiva di queste tabelle supera la capacità di un account di archiviazione, è necessario creare ulteriori account di archiviazione e suddividere le tabelle tra questi. Se il numero di account di archiviazione supera il numero di account disponibili per una sottoscrizione, potrebbe essere necessario utilizzare più sottoscrizioni.

## Progettazione di partizioni per le prestazioni delle query

Le prestazioni delle query possono spesso essere aumentate utilizzando set di dati più piccoli e l'esecuzione di query parallele. Ogni partizione deve contenere una piccola parte dell'intero set di dati e la riduzione del volume può migliorare le prestazioni delle query. Tuttavia, il partizionamento non è un'alternativa per la progettazione e la configurazione di un database in modo appropriato. Ad esempio, assicurarsi di disporre degli indici necessari richiesti se si utilizza un database relazionale.

Quando si progettano le partizioni per le prestazioni delle query, attenersi alla seguente procedura:

1. Esaminare i requisiti dell'applicazione e delle prestazioni:
	- Utilizzare i requisiti aziendali per determinare le query critiche che devono sempre essere eseguite rapidamente.
	- Monitoraggio del sistema per identificare qualsiasi query eseguita lentamente.
	- Stabilire quali le query vengono eseguite più frequentemente. Una singola istanza di ogni query potrebbe avere un costo minimo, ma il consumo cumulativo di risorse potrebbe essere significativo. Può essere vantaggioso separare i dati recuperati da queste query in una partizione distinta o anche in una cache.
2. Partizionare i dati che causano un rallentamento delle prestazioni. Assicurarsi di:
	- Limitare le dimensioni di ogni partizione in modo che il tempo di risposta della query sia compreso nel target.
	- Progettare la chiave di partizionamento in modo che l'applicazione possa trovare facilmente la partizione, se si implementa il partizionamento orizzontale. In questo modo la query non deve analizzare ogni partizione.
	- Considerare la posizione di una partizione sulle prestazioni delle query. Se possibile, provare a mantenere i dati nelle partizioni geograficamente vicine alle applicazioni e gli utenti che vi accedono.
3. Se un'entità dispone di requisiti relativi alle prestazioni di velocità effettiva e della query, utilizzare il partizionamento funzionale in base a tale entità. Se tale entità non è in grado di soddisfare i requisiti, è necessario applicare anche il partizionamento orizzontale. Nella maggior parte dei casi è sufficiente una singola strategia di partizionamento, ma in alcuni casi è preferibile combinare entrambe le strategie.
4. È possibile utilizzare query asincrone che vengono eseguite in parallelo tra le partizioni per migliorare le prestazioni.

## Progettazione di partizioni per la disponibilità

Il partizionamento dei dati può migliorare la disponibilità delle applicazioni garantendo che l'intero set di dati non costituisca un singolo punto di errore e che i singoli sottoinsiemi del set di dati possano essere gestiti in modo indipendente. Replicare le partizioni che contengono dati critici può inoltre migliorare la disponibilità.

Quando si progettano e implementano partizioni, considerare i seguenti fattori che influiscono sulla disponibilità:

- Criticità dei dati nelle operazioni aziendali. Alcuni dati potrebbero includere informazioni aziendali critiche, ad esempio dettagli di fatture o transazioni bancarie. Altri dati possono essere meno critici sui dati operativi, ad esempio i file di log, tracce di prestazioni e così via. Dopo aver individuato tutti i tipi di dati, prendere in considerazione:
	- L’archiviazione dei dati critici in partizioni a disponibilità elevata con un piano di backup appropriato.
	- La definizione di gestione separata e meccanismi di monitoraggio o procedure per le diverse criticità di ogni set di dati. Il posizionamento di dati che hanno lo stesso livello di criticità nella stessa partizione in modo da poter eseguire il backup con una frequenza appropriata. Le partizioni contenenti dati per le transazioni bancarie, ad esempio, potrebbero richiedere backup più frequenti rispetto alle partizioni che contengono informazioni di registrazione o di traccia.
- Come gestire le singole partizioni. La progettazione di partizioni per supportare la manutenzione e la gestione indipendenti offre diversi vantaggi. Ad esempio:
	- Se una partizione fallisce, può essere recuperata in modo indipendente, senza interferire con le istanze delle applicazioni che accedono ai dati di altre partizioni.
	- Il partizionamento dei dati per aree geografiche può consentire attività di manutenzione pianificate che vengono eseguite in determinate fasce orarie per ogni posizione. Assicurarsi che le partizioni non siano troppo grandi per evitare che le operazioni di manutenzione pianificata non siano completate durante questo periodo.
- Indica se replicare i dati critici tra le partizioni. Questa strategia può migliorare disponibilità e prestazioni, anche se può causare problemi di coerenza. Occorre tempo prima che le modifiche apportate ai dati in una partizione siano sincronizzate con ogni replica e, durante questo periodo, diverse partizioni conterranno valori di dati diversi.

## Considerazioni e problemi

L’utilizzo del partizionamento aggiunge complessità alla progettazione e allo sviluppo del sistema. È importante considerare il partizionamento come parte fondamentale della progettazione del sistema anche se inizialmente il sistema contiene una singola partizione. L’indirizzamento del partizionamento per ripensamento quando il sistema inizia ad accusare problemi di prestazioni e scalabilità aumenta solo la complessità, dal momento che il sistema va mantenuto in tempo reale. L'aggiornamento del sistema per incorporare il partizionamento in questo ambiente richiede non solo la modifica della logica di accesso ai dati, ma può causare anche la migrazione di grandi quantità di dati esistenti per distribuirli tra partizioni, spesso mentre gli utenti si aspettano di essere in grado di continuare a utilizzare il sistema.

In alcuni casi, il partizionamento non è considerato importante perché il set di dati iniziale è ridotto e può essere facilmente gestito da un singolo server. Ciò può verificarsi in un sistema che non prevede una scalabilità oltre alle dimensioni iniziali, ma molti sistemi commerciali devono essere in grado di espandersi se il numero di utenti aumenta. Questa espansione in genere è accompagnata da un aumento delle dimensioni del volume di dati. È inoltre necessario comprendere che il partizionamento non è sempre una funzione di archivi dati di grandi dimensioni. Ad esempio, un archivio dati di piccole dimensioni potrebbe essere utilizzato molto frequentemente da centinaia di client simultanei. Il partizionamento dei dati in questa situazione può aiutare a ridurre i conflitti e a migliorare la velocità effettiva.

Quando si progetta un schema di partizionamento dei dati, è necessario considerare quanto riportato di seguito:

- Dove possibile, mantenere i dati per le operazioni di database più comuni insieme in ogni partizione per ridurre al minimo le operazioni di accesso ai dati tra partizioni. Le query tra partizioni possono richiedere più tempo rispetto alle query all'interno di una singola partizione, ma ottimizzare le partizioni per un set di query potrebbe avere effetti negativi su latri set di query. Per ridurre al minimo il tempo di query tra partizioni in cui non è possibile evitare ciò, eseguire le query parallele sulle partizioni e aggregare i risultati all'interno dell'applicazione. Tuttavia, questo approccio potrebbe non essere possibile in alcuni casi, ad esempio quando è necessario ottenere un risultato da una query e utilizzarlo nella query successiva.
- Se le query utilizzano dati di riferimento relativamente statici, ad esempio tabelle di codici postali o elenchi di prodotti, è necessario considerare la replica dei dati in tutte le partizioni per ridurre la richiesta di un'operazione di ricerca separata in un’altra partizione. Questo approccio può inoltre ridurre la probabilità che i dati di riferimento diventino un set di dati "critici" soggetti a traffico elevato nell'intero sistema, anche se esiste un costo aggiuntivo relativo alla sincronizzazione di tutte le modifiche che potrebbero verificarsi per i dati di riferimento.
- Dove possibile, ridurre al minimo i requisiti per l'integrità referenziale tra le partizioni verticali e funzionali. In questi schemi, l'applicazione stessa è responsabile della gestione dell'integrità referenziale tra le partizioni quando i dati vengono aggiornati e utilizzati. Le query che devono unire i dati tra più partizioni vengono eseguite più lentamente delle query che consentono di unire solo i dati all'interno della stessa partizione, poiché l'applicazione in genere richiede di eseguire query consecutive basate su una chiave e quindi su una chiave esterna. Si consiglia di replicare o de-normalizzare i dati rilevanti. Per ridurre al minimo il tempo di query in cui i join tra partizioni sono necessari, eseguire query parallele tramite le partizioni e unire i dati all'interno dell'applicazione.
- È necessario considerare l'effetto che lo schema di partizionamento potrebbe avere sulla coerenza dei dati tra partizioni. È opportuno valutare se la coerenza assoluta è effettivamente un requisito. Al contrario, un approccio comune nel cloud consiste nell'implementare la coerenza finale. I dati in ogni partizione vengono aggiornati separatamente e la logica dell'applicazione può assumersi la responsabilità di garantire che gli aggiornamenti siano completati correttamente, e gestire le incoerenze che possono essere generate da query dei dati durante l'esecuzione di un'operazione coerente. Per ulteriori informazioni sull'implementazione di coerenza finale, vedere le Indicazioni di coerenza. (#insertlink #)
- È necessario considerare come le query individuano la partizione corretta. Se una query deve analizzare tutte le partizioni per individuare i dati richiesti, ci sarà un impatto significativo sulle prestazioni, anche utilizzando più query parallele. Le query utilizzate con strategie di partizionamento verticale e funzionale possono naturalmente specificare le partizioni. Tuttavia, quando si utilizza il partizionamento orizzontale (sharding), l’individuazione di un elemento può essere difficile poiché ogni partizione ha lo stesso schema. Una tipica soluzione di partizionamento orizzontale consiste nel mantenere una mappa che può essere utilizzata per cercare il percorso della partizione per elementi specifici di dati. Questa mappa può essere implementata nella logica di partizionamento orizzontale dell'applicazione o gestita dall'archivio dati se supporta il partizionamento orizzontale trasparente.
- Quando si utilizza una strategia di partizionamento orizzontale, è necessario prendere in considerazione periodicamente il ribilanciamento delle partizioni per distribuire uniformemente i dati secondo le dimensioni e il carico di lavoro per ridurre al minimo gli hotspot, ottimizzare le prestazioni delle query e aggirare le limitazioni di archiviazione fisica. Tuttavia, si tratta di un'attività complessa che spesso richiede l'utilizzo di uno strumento personalizzato o di un processo.
- La replica di ogni partizione fornisce protezione aggiuntiva in caso di esito negativo. Se una singola replica ha esito negativo, le query possono essere indirizzate verso una copia di lavoro.
- Se si raggiungono i limiti fisici di una strategia di partizionamento, potrebbe essere necessario estendere la scalabilità a un livello diverso. Ad esempio, se il partizionamento è a livello di database, questo può implicare l’individuazione o la replica delle partizioni in più database. Se il partizionamento è già a livello di database e i limiti fisici sono un problema, questo potrebbe implicare l’individuazione o la replica delle partizioni in più account di hosting.
- Evitare transazioni che accedono ai dati in più partizioni. Alcuni archivi di dati implementano la coerenza transazionale e l’integrità per le operazioni che modificano i dati, ma solo quando si trovano in una singola partizione. Se è necessario supporto transazionale tra più partizioni, probabilmente sarà necessario implementare questo come parte della logica dell'applicazione poiché la maggior parte dei sistemi di partizionamento non forniscono il supporto nativo.

Tutti gli archivi dati richiedono una gestione operativa e il monitoraggio dell'attività. Le attività variano dal caricamento dei dati, backup e ripristino dei dati, riorganizzazione dei dati e la garanzia che il sistema funziona in modo corretto ed efficiente.

Considerare i seguenti fattori che influiscono sulla gestione operativa:

- Prendere in considerazione come verranno implementate una gestione appropriata e le attività operative quando i dati saranno partizionati, ad esempio backup e ripristino, l'archiviazione dei dati, il monitoraggio del sistema e altre attività amministrative. Mantenere la coerenza logica durante le operazioni di backup e ripristino, ad esempio, può essere una sfida.
- Come i dati possono essere caricati in più partizioni e come i nuovi dati provenienti da altre origini possono essere aggiunti. Alcuni strumenti e utilità potrebbero non supportare le operazioni di dati partizionati quali il caricamento di dati nella partizione corretta e questo potrebbe richiedere la creazione o l’utilizzo nuovi strumenti e utilità.
- Come i dati verranno archiviati ed eliminati a intervalli regolari (magari ogni mese) per impedire una crescita eccessiva delle partizioni. È necessario trasformare i dati in base a uno schema di archiviazione differente.
- Considerare l'esecuzione di un processo periodico per individuare eventuali problemi di integrità dei dati, ad esempio i dati in una partizione che fa riferimento alle informazioni in un’altra, ma queste informazioni mancano. Il processo potrebbe o tentare di correggere automaticamente questi problemi o generare un avviso a un operatore per risolvere i problemi manualmente. Ad esempio, in un'applicazione di e-commerce, informazioni sugli ordini potrebbero essere conservate in una partizione, ma le voci che costituiscono ogni ordine potrebbero essere conservate in un’altra. Il processo di individuazione di un ordine deve aggiungere i dati a entrambe le partizioni. Se questo processo fallisce, potrebbe essere archiviate voci per le quali non esiste alcun ordine corrispondente.

Le tecnologie di archiviazione di dati diversi in genere forniscono le proprie funzionalità per il supporto di partizionamento. Nelle sezioni seguenti vengono riepilogate le opzioni implementate da archivi dati comunemente utilizzati dalle applicazioni Azure e vengono descritte le considerazioni per la progettazione di applicazioni che possono trarre il massimo vantaggio da queste funzionalità.

## Strategie di partizionamento per Database SQL Azure

Il Database di SQL Azure è un database relazionale as-a-service che viene eseguito nel cloud. È basato su Microsoft SQL Server. Un database relazionale divide le informazioni in tabelle e ogni tabella contiene informazioni sulle entità come una serie di righe. Ogni riga include colonne che contengono i dati per i singoli campi di un'entità. La pagina [Database SQL di Azure](https://msdn.microsoft.com/library/azure/ee336279.aspx) del sito Web Microsoft fornisce informazioni dettagliate sulla creazione e l’utilizzo di database SQL.

## Partizionamento orizzontale con scalabilità elastica

Un singolo database SQL ha un limite per il volume dei dati che può contenere e la velocità effettiva è vincolata da fattori di architettura e dal numero di connessioni simultanee che supporta. Il database di SQL Azure fornisce scalabilità elastica per supportare la scalabilità orizzontale per un database SQL. Utilizzando una certa scalabilità elastica, è possibile partizionare i dati in partizioni distribuite in più database SQL ed è possibile aggiungere o rimuovere partizioni quando il volume di dati da gestire aumenta e si riduce. Utilizzando la scalabilità elastica può inoltre contribuire a ridurre i conflitti distribuendo il carico tra i database.

> [AZURE.NOTE]La scalabilità elastica è attualmente in anteprima a partire da gennaio 2015. È una sostituzione per le federazioni di Database SQL Azure che verranno ritirate. Installazioni esistenti di federazione di Database SQL Azure possono essere migrate alla scalabilità elastica utilizzando l’[Utilità di migrazione di federazioni](https://code.msdn.microsoft.com/vstudio/Federations-Migration-ce61e9c1). In alternativa, è possibile implementare un proprio meccanismo di partizionamento orizzontale se lo scenario non si presta naturalmente alle funzionalità fornite dalla scalabilità elastica.

Ogni partizione viene implementata come un database SQL. Una partizione può contenere più di un set di dati (il riferimento sarà _shardlet_), e ogni database mantiene i metadati che descrivono gli shardlet contenuti al suo interno. Un shardlet può essere un singolo elemento dati o può essere un gruppo di elementi che condividono la stessa chiave shardlet. Ad esempio, se si stanno partizionando dati in un'applicazione multi-tenant, la chiave shardlet potrebbe essere l'ID tenant e tutti i dati per un tenant specificato saranno conservati come parte dello shardlet stesso. I dati per altri tenant saranno conservati in shardlet diversi.

È compito del programmatore associare un set di dati a una chiave shardlet. Un database SQL separato funge da un responsabile del mapping della partizione globale che contiene un elenco di database (partizioni) che includono l'intero sistema e le informazioni sugli shardlets in ogni database. Un'applicazione client che accede ai dati si connette prima al database di gestione mapping della partizione globale per ottenere una copia della partizione-mappa (elenco partizioni e shardlet) che memorizza nella cache in locale. Quindi, l'applicazione utilizza queste informazioni per indirizzare le richieste alla partizione appropriata. Questa funzionalità è nascosta dietro una serie di API contenute nella libreria client di scalabilità elastica del database SQL di Azure, disponibile come pacchetto NuGet. La pagina [Informazioni generali sulla scalabilità elastica del database SQL di Azure](sql-database-elastic-scale-introduction.md) sul sito Web Microsoft fornisce un'introduzione più completa alla scalabilità elastica.

> [AZURE.NOTE]È possibile replicare il database di gestione di mapping della partizione globale per ridurre la latenza e migliorare la disponibilità. Se si implementa il database utilizzando una delle fasce di prezzo Premium di prezzo è possibile configurare la replica geografica attiva per copiare continuamente i dati in database situati in diverse aree geografiche. Creare una copia del database in ogni regione in cui gli utenti si basano e configurare l'applicazione per connettersi a questa copia per ottenere il mapping della partizione.

> Un approccio alternativo consiste nell'utilizzare la sincronizzazione dati SQL Azure o una pipeline di Data Factory di Azure per replicare il database di gestione di mapping della partizione in aree geografiche. Il modulo di replica viene eseguito periodicamente e risulta più appropriato se il mapping della partizione viene modificato raramente. Inoltre, il database di gestione di mapping della partizione non deve essere creato utilizzando una fascia di prezzo Premium.

La scalabilità elastica fornisce due schemi per la mappature di dati per gli shardlet e per archiviarli in partizioni:

- Un elenco di mappatura delle partizioni descrive un'associazione tra la singola chiave e uno shardlet. Ad esempio, in un sistema multi-tenant, i dati per ogni tenant potrebbero essere associati a una chiave univoca e archiviati in un proprio shardlet. Per garantire la riservatezza e l'isolamento (per impedire a un tenant di esaurire le risorse di archiviazione di dati disponibili ad altri utenti), ogni shardlet potrebbe essere bloccato all'interno della propria partizione.

![](media/best-practices-data-partitioning/PointShardlet.png)

_Figura 4. -Utilizzo di un elenco di mappatura delle partizioni per archiviare i dati del tenant in partizioni separate_

- Una mappa partizione di tipo intervallo descrive un'associazione tra un set di valori di chiavi contigue e uno shardlet. Nell'esempio di multi-tenant descritto in precedenza, come alternativa all'implementazione di shardlet dedicati, è possibile raggruppare i dati per un set di tenant (ognuno con la propria chiave) all'interno di uno stesso shardlet. Questo schema è meno costoso del primo (i tenant condividono le risorse di archiviazione di dati), ma soggetto a una riduzione della privacy e dell’isolamento dei dati.

![](media/best-practices-data-partitioning/RangeShardlet.png)

_Figura 5. -Utilizzo di una mappa di partizione di tipo intervallo per archiviare i dati per un intervallo di tenant in una partizione_

Si noti che una singola partizione può contenere i dati per shardlet diversi. Ad esempio, è possibile utilizzare elenchi di shardlet per archiviare i dati per i diversi tenant non contigui nella stessa partizione. È inoltre possibile combinare intervalli di shardlet ed elenchi di shardlet nella partizione stessa, anche se verranno indirizzati tramite diversi mapping nel database di gestione di mapping della partizione globale (il database di gestione di mapping della partizione globale può contenere più mappe di partizionamento). La figura 6 descrive questo approccio.

![](media/best-practices-data-partitioning/MultipleShardMaps.png)

_Figura 6. -Implementazione di più mappe di partizione_

Lo schema di partizionamento implementato può avere un impatto significativo sulle prestazioni del sistema e può inoltre modificare la frequenza con cui le partizioni devono essere aggiunte o rimosse o i dati ripartizionati tra le partizioni. Quando si utilizza la scalabilità elastica per partizionare i dati, è necessario considerare quanto riportato di seguito:

- Raggruppare i dati utilizzati insieme nella stessa partizione ed evitare operazioni di accesso ai dati contenuti in più partizioni. Tenere presente che con una certa la scalabilità elastica una partizione è un database SQL con diritti propri e Database SQL di Azure non supporta i join tra database. Queste operazioni devono essere eseguite sul lato client. È importante ricordare che con l'integrità referenziale del Database SQL di Azure vincoli, trigger e procedure archiviate in un database non possono fare riferimento gli oggetti in un altro, quindi non è possibile progettare un sistema con dipendenze tra le partizioni. Tuttavia, un database SQL può contenere tabelle che contengono copie dei dati di riferimento utilizzati di frequente da query e altre operazioni e queste tabelle non devono appartenere a nessuno shardlet specifico. Replica dei dati tra partizioni può aiutare a rimuovere la necessità di unire dati che si estendono a più database. In teoria, tali dati devono essere statici o lenti per ridurre al minimo lo sforzo di replica e ridurre le probabilità di diventare obsoleti.

	> [AZURE.NOTE]Anche se il Database SQL Azure non supporta i join tra database, l'API di scalabilità elastica consente di eseguire query tra partizioni che possono scorrere in modo trasparente tra i dati contenuti in tutti gli shardlet a cui fa riferimento un mapping della partizione. L’API di scalabilità elastica suddivide le query tra partizioni in una serie di singole query (una per ogni database) e quindi unisce insieme i risultati. Per ulteriori informazioni, vedere la pagina [Query Multi-Shard](sql-database-elastic-scale-multishard-querying.md) sul sito Web Microsoft.

- I dati archiviati in shardlet che appartengono alla stessa mappa di partizione devono avere lo stesso schema. Ad esempio, non creare un elenco di mappe di partizionamento che puntano ad alcuni shardlet contenenti i dati del tenant e ad altri shardlet contenenti informazioni sul prodotto. Questa regola non viene applicata dalla scalabilità elastica, ma la gestione dei dati e l'esecuzione di query diventa molto complessa se ogni shardlet dispone di uno schema diverso. Nell'esempio precedente, è necessario creare due elenchi di mappe di partizionamento, uno riferito ai dati tenant e l'altro alle informazioni sul prodotto. Si tenga presente che i dati appartenenti a diversi shardlet possono essere archiviati nella stessa partizione.

	> [AZURE.NOTE]La funzionalità di query tra partizioni dell'API di scalabilità elastica dipende da ogni shardlet nella mappa di partizione che contiene lo stesso schema.
- Le operazioni transazionali sono supportate solo per i dati contenuti all'interno della stessa partizione e non tra partizioni. Le transazioni possono estendere gli shardlet in quanto parti della stessa partizione. Pertanto, la logica di business deve eseguire transazioni, archiviare i dati nella partizione stessa oppure implementare la coerenza finale. Per ulteriori informazioni, vedere le Indicazioni sulla coerenza dei dati.
- Posizionare le partizioni vicino agli utenti che accedono ai dati in tali partizioni (geo-localizzazione delle partizioni). Questa strategia contribuirà a ridurre la latenza.
- Evitare di utilizzare una combinazione di partizioni attive (hotspot) e partizioni relativamente inattive. Provare e distribuire uniformemente il carico tra partizioni. Questo potrebbe richiedere l’hashing delle chiavi shardlet.
- In caso di individuazione geografica delle partizioni, assicurarsi che le chiavi con hashing eseguano il mapping di shardlet contenuti in partizioni archiviate vicino agli utenti che accedono a tali dati.
- Attualmente, solo un set limitato di dati SQL è supportato come chiavi shardlet; _int, bigint, varbinary,_ e _uniqueidentifier_. L'istruzione SQL _int_ e _bigint_corrisponde ai tipi di dati in c# _int_ e _long_, e hanno gli stessi intervalli. Il codice SQL _varbinary_ può essere gestito tramite un _Byte_ matrice in c# e il tipo SQL _uniqueidentier_ corrisponde alla classe _Guid_ in .NET Framework.

Come suggerisce il nome, la scalabilità elastica consente al sistema di aggiungere e rimuovere partizioni quando il volume dei dati cresce e si riduce. Le API nella libreria client di scalabilità elastica del database SQL di Azure consentono a un'applicazione di creare ed eliminare partizioni in modo dinamico (e aggiornare in modo trasparente la gestione di mapping della partizione), ma la rimozione di una partizione è un'operazione distruttiva che richiede l'eliminazione di tutti i dati in tale partizione. Se un'applicazione deve suddividere una partizione in due partizioni separate o combinare partizioni, la scalabilità elastica fornisce un servizio di suddivisione/unione separato. Questo servizio viene eseguito in un servizio ospitato nel cloud (lo sviluppatore deve creare il servizio ospitato nel cloud) e si occupa di migrazione dei dati tra le partizioni in modo sicuro. Per ulteriori informazioni, vedere l'argomento [Suddivisione e unione con scalabilità elastica](sql-database-elastic-scale-overview-split-and-merge.md) sul sito Web Microsoft.

## Strategie di partizionamento per l’archiviazione di Azure

L’archiviazione di Azure fornisce tre astrazioni per la gestione dei dati:

- Archiviazione tabelle, che implementa l'archiviazione di struttura scalabile. Una tabella contiene una raccolta di entità, ognuna delle quali può contenere un set di proprietà e valori.
- Archiviazione BLOB, che fornisce l'archiviazione per i file e gli oggetti di grandi dimensioni.
- Code di archiviazione, che supporta la messaggistica asincrona affidabile tra applicazioni.

Archiviazione tabelle e archiviazione Blob sono essenzialmente archivi di valori chiave ottimizzati per contenere rispettivamente dati strutturati e non strutturati. Le code di archiviazione forniscono un meccanismo per la creazione di applicazioni scalabili, a regime di controllo libero. Archiviazione tabelle, archiviazione Blob e code di archiviazione vengono create all'interno del contesto di un account di archiviazione di Azure. Gli account di archiviazione di Azure supportano tre forme di ridondanza:

- Archiviazione con ridondanza locale, che mantiene tre copie dei dati all'interno di un singolo centro dati. Questa forma di ridondanza protegge dagli errori hardware ma non da una situazione di emergenza che interessa l'intero centro dati.
- Archiviazione con ridondanza della zona che mantiene tre copie dei dati distribuiti tra più centri dati diversi nella stessa area (o in due aree geograficamente vicine). Questa forma di ridondanza permette di proteggersi da emergenze che si verificano all'interno di un singolo centro dati, ma non offrono protezione da disconnessioni di rete su larga scala che interessano un'intera area. Si noti che l'archiviazione con ridondanza della zona attualmente è disponibile solo per i BLOB in blocchi.
- Archiviazione con ridondanza geografica, che mantiene sei copie dei dati :tre copie in un'unica area (l'area locale) e le altre tre copie in un'area remota. Questa forma di ridondanza fornisce il massimo livello di protezione dalle emergenze.

Microsoft ha pubblicato gli obiettivi di scalabilità per gli account di archiviazione di Azure:vedere la pagina [Obiettivi di scalabilità e prestazioni per Archiviazione di Azure](https://msdn.microsoft.com/library/azure/dn249410.aspx) del sito Web Microsoft. Attualmente, la capacità totale dell’account di archiviazione (la dimensione dei dati memorizzati nell'archiviazione tabelle, l'archiviazione blob e i messaggi in sospeso vengono conservati nella coda di archiviazione) non può superare i 500 TB. La velocità massima della richiesta (presupponendo un'entità di 1KB, blob o dimensione del messaggio) è 20 KB al secondo. Se il sistema probabilmente supererà questi limiti, è possibile il partizionamento del carico tra più account di archiviazione; una singola sottoscrizione di Azure può creare fino a 100 account di archiviazione. Si noti tuttavia che questi limiti possono cambiare nel tempo.

## Partizionamento di archiviazione tabelle di Azure

Archiviazione tabelle di Azure è una chiave/valore archiviato, progettato sulla base del partizionamento. Tutte le entità vengono archiviate in una partizione e le partizioni vengono gestite internamente dall'archiviazione tabelle di Azure. Ogni entità archiviata in una tabella deve fornire la chiave in due parti che comprende:

- La chiave di partizione. Questo sono valori di stringa che determinano in quale partizione di archiviazione tabelle di Azure verrà inserita l'entità. Tutte le entità con la stessa chiave di partizione verranno archiviate nella stessa partizione.
- La chiave di riga Si tratta di un altro valore di stringa che identifica l'entità all'interno della partizione. Tutte le entità all'interno di una partizione vengono ordinate in base al livello lessicale, in ordine crescente, per chiave. La combinazione chiave di partizione/chiave di riga deve essere univoca per ogni entità e non può superare 1 KB di lunghezza.

Il resto dei dati di un'entità è costituito da campi definiti dall'applicazione. Non vengono applicati schemi particolari e ogni riga può contenere un diverso set di campi definiti dall'applicazione. L'unica limitazione è che la dimensione massima di un'entità (incluse le chiavi di riga e di partizione) attualmente è 1 MB. La dimensione massima di una tabella è pari a 200 TB, anche se questi dati possono cambiare in futuro (selezionare la pagina [Obiettivi di scalabilità e prestazioni per Archiviazione di Azure](https://msdn.microsoft.com/library/azure/dn249410.aspx) sul sito Web Microsoft per le informazioni più recenti su queste limitazioni. Se si sta tentando di archiviare le entità che superano questa capacità, è consigliabile la suddivisione in più tabelle, l’utilizzare del partizionamento verticale e la suddivisione dei campi in gruppi probabilmente più accessibili contemporaneamente.

La figura 7 mostra la struttura logica di un esempio di account di archiviazione (dati di Contoso) di un'applicazione di e-commerce fittizia. Gli account di archiviazione contengono tre tabelle (informazioni sul cliente, informazioni sul prodotto e informazioni relative all'ordine) e ogni tabella dispone di più partizioni. Nella tabella Informazioni sul cliente, i dati vengono partizionati in base alle città in cui si trova il cliente e la chiave di riga contiene l'ID cliente. Nella tabella Informazioni sul prodotto, i prodotti vengono partizionati per categoria e la chiave di riga contiene il numero del prodotto. Nella tabella Informazioni relative all'ordine, gli ordini vengono partizionati in base alla data in cui venivano collocati e la chiave di riga specifica l’ora di ricezione dell'ordine. Si noti che tutti i dati sono ordinati per chiave di riga in ogni partizione.

![](media/best-practices-data-partitioning/TableStorage.png)

_Figura 7. -Le tabelle e le partizioni in un esempio di account di archiviazione_

> [AZURE.NOTE]Archiviazione tabelle di Azure aggiunge inoltre un campo timestamp per ogni entità. Il campo timestamp viene gestito dall'archiviazione tabelle e viene aggiornato ogni volta che l'entità viene modificata e scritta su una partizione. Il servizio di archiviazione tabelle utilizza questo campo per implementare la concorrenza ottimistica (ogni volta che un'applicazione scrive un'entità in archiviazione tabelle, il servizio di archiviazione tabelle confronta il valore del timestamp dell'entità da scrivere con il valore contenuto nell'archiviazione tabelle e, se sono diversi, un'altra applicazione deve aver modificato l'entità dal momento che è stata recuperata e l'operazione di scrittura ha esito negativo). È consigliabile non modificare questo campo nel proprio codice e nemmeno specificare un valore per questo campo quando si crea una nuova entità.

Archiviazione tabelle di Azure utilizza la chiave di partizione per determinare come archiviare i dati. Se un'entità viene aggiunta a una tabella con una chiave di partizione precedentemente non utilizzata, archiviazione tabelle di Azure creerà una nuova partizione per questa entità. Tutte le altre entità con la stessa chiave di partizione verranno archiviate nella stessa partizione. Questo meccanismo implementa in modo efficace una strategia di scalabilità automatica. Ogni partizione verrà archiviata in un singolo server in un centro dati di Azure (per assicurare che le query che recuperano dati da una singola partizione siano eseguite rapidamente), ma diverse partizioni possono essere distribuite in più server. Inoltre, un singolo server può ospitare più partizioni, se queste partizioni hanno dimensioni limitate.

Quando si progettano le entità per l'archiviazione tabelle di Azure, è necessario considerare quanto riportato di seguito:

- La selezione dei valori della chiave di partizione e della chiave e di riga deve essere guidata dal modo in cui si accede ai dati. È consigliabile scegliere una combinazione di chiave di partizionei/chiave di riga che supporti la maggior parte delle query. Le query più efficienti recupereranno i dati specificando la chiave di partizione e la chiave di riga. Query che specificano una chiave di partizione e un intervallo di chiavi di riga possono essere soddisfatte analizzando una singola partizione. Ciò è relativamente veloce perché i dati vengono conservati in ordine secondo la chiave di riga. Query che non specificano almeno la chiave di partizione possono richiedere l'archiviazione tabelle di Azure per l'analisi di ogni partizione per i dati.

	> [AZURE.TIP]Se un'entità dispone di una chiave naturale, è consigliabile utilizzarla come chiave di partizione e specificare una stringa vuota come chiave di riga. Se un'entità dispone di una chiave composta che comprende due proprietà, selezionare la proprietà che cambia più lentamente come chiave di partizione e l'altra proprietà come chiave di riga. Se un'entità dispone di più di due proprietà chiave, utilizzare una concatenazione delle proprietà per fornire le chiavi di partizione e di riga.

- Se si eseguono regolarmente query per cercare i dati che utilizzano campi diversi dalle chiavi di partizione e di riga, si consiglia di implementare l’ [Index Table Pattern](https://msdn.microsoft.com/library/dn589791.aspx).
- Se le chiavi di partizione vengono generate utilizzando una sequenza monotona di aumento o diminuzione (ad esempio "0001", "0002", "0003",...) e ogni partizione contiene solo una quantità limitata di dati, archiviazione tabelle di Azure può raggruppare fisicamente queste partizioni insieme nello stesso server. Questo meccanismo presuppone che l'applicazione più probabilmente eseguirà query su un intervallo contiguo di partizioni (query di intervallo) ed è ottimizzato per questo caso. Questo approccio può tuttavia causare hotspot focalizzati su un singolo server quando tutti gli inserimenti di nuove entità saranno probabilmente concentrati su una delle due estremità di intervalli contigui. Permette inoltre di ridurre la scalabilità. Per distribuire il carico in modo più uniforme tra i server, prendere in considerazione la chiave di partizione per rendere più casuale la sequenza.
- Archiviazione tabelle di Azure supporta le operazioni transazionali per le entità che appartengono alla stessa partizione. Ciò significa che un'applicazione può eseguire più operazioni di inserimento, aggiornamento, eliminazione, sostituzione o unione come unità atomica (l’oggetto della transazione non include più di 100 entità e il carico utile della richiesta non supera i 4 MB di dimensioni). Le operazioni che si estendono su più partizioni non sono transazionali e potrebbe essere necessario implementare coerenza finale seguendo le Indicazioni di coerenza dei dati. Per ulteriori informazioni sull'archiviazione tabelle e le transazioni, visitare la pagina [Esecuzione di transazioni dei gruppi di entità](https://msdn.microsoft.com/library/azure/dd894038.aspx)sul sito Web Microsoft.
- Prestare attenzione alla granularità della chiave di partizione:
	- Utilizzare la stessa chiave di partizione per ogni entità spingerà il servizio di archiviazione tabelle a creare una singola partizione di grandi dimensioni contenuta in un unico server impedendone la scalabilità e la concentrazione del carico su un singolo server. Di conseguenza, questo approccio è adatto solo per sistemi che gestiscono un numero ridotto di entità. Tuttavia, questo approccio garantisce che tutte le entità possano partecipare alle transazioni del gruppo di entità.
	- Utilizzare una chiave di partizione univoca per ogni entità spingerà il servizio di archiviazione tabelle a creare una partizione separata per ogni entità, con un conseguente numero elevato di partizioni di piccole dimensioni (a seconda delle dimensioni delle entità). Questo approccio è più scalabile rispetto all'utilizzo di una chiave singola di partizione, ma non sono possibili transazioni del gruppo di entità e le query che recuperano più di un'entità possono comportare la lettura da più di un server. Tuttavia, se l'applicazione esegue query di intervallo, l’utilizzo di una sequenza monotona per generare le chiavi di partizione può ottimizzare le query.
	- La condivisione della chiave di partizione in un sottoinsieme di entità consente di raggruppare le entità correlate nella stessa partizione. È possibile eseguire le operazioni che coinvolgono le entità correlate tramite transazioni del gruppo di entità, e le query che recuperano un set di entità correlate possono essere soddisfatte dall’accesso a un singolo server.

Per ulteriori informazioni sul partizionamento dei dati nell'archiviazione tabelle di Azure, vedere l'articolo [Progettazione di una strategia di partizionamento scalabile per l'archiviazione tabelle di Azure](https://msdn.microsoft.com/library/azure/hh508997.aspx) sul sito Web Microsoft.

## Partizionamento di archiviazione blob di Azure

Archiviazione Blob di Azure consente di contenere oggetti binari di grandi dimensioni, dimensioni per i BLOB in blocchi attualmente fino a 200 GB o 1 TB per BLOB di pagine (per informazioni più recenti, visitare la pagina [Obiettivi di scalabilità e prestazioni per Archiviazione di Azure](https://msdn.microsoft.com/library/azure/dn249410.aspx) sul sito Web Microsoft). Utilizzo dei BLOB in blocchi in scenari come i flussi dove è necessario caricare o scaricare rapidamente grandi volumi di dati. Utilizzo dei BLOB di pagine per le applicazioni che richiedono accesso casuale anziché seriale a parti dei dati.

Ogni blob (blocco o pagina) viene conservato in un contenitore in un account di archiviazione Azure. È possibile utilizzare i contenitori per raggruppare BLOB correlati che presentano gli stessi requisiti di sicurezza, sebbene questo raggruppamento sia logico anziché fisico. All'interno di un contenitore ogni blob ha un nome univoco.

Archiviazione BLOB viene partizionata automaticamente in base al nome del blob. Ogni blob viene mantenuto nella propria partizione e i BLOB nello stesso contenitore non condividono una partizione. Questa architettura consente all'archiviazione blob di Azure di bilanciare il carico tra server in modo trasparente quando BLOB diversi nello stesso contenitore possono essere distribuiti in server diversi.

Le operazioni di scrittura di un singolo blocco (blob in blocchi) o una pagina (blob di pagine) sono atomiche, ma le operazioni che interessano blocchi, pagine o BLOB non lo sono. Se è necessario garantire la coerenza durante l'esecuzione di operazioni di scrittura in blocchi, pagine e BLOB, sarà necessario estrarre un blocco di scrittura utilizzando un lease del blob.

Archiviazione blob di Azure supporta velocità di trasferimento fino a 60 MB al secondo o 500 richieste al secondo per ogni BLOB. Se si prevede di superare tali limiti e i dati BLOB sono relativamente statici, provare a replicare BLOB utilizzando la rete per la distribuzione di contenuti di Azure (rete CDN). Per ulteriori informazioni, vedere la pagina [ServicePoint Class](cdn-how-to-use.md) sul sito Web Microsoft. Per ulteriori indicazioni e considerazioni, vedere l'articolo Rete per la distribuzione di contenuti (rete CDN).

## Partizionamento di code di archiviazione di Azure

Le code di archiviazione di Azure consentono di implementare la messaggistica asincrona tra processi. Un account di archiviazione di Azure può contenere qualsiasi numero di code e ogni coda può contenere qualsiasi numero di messaggi. L'unica limitazione è lo spazio disponibile nell'account di archiviazione. La dimensione massima di un singolo messaggio è 64 KB. Se sono necessari messaggi di dimensioni superiori, utilizzare Code del bus di servizio di Azure.

Ogni coda di archiviazione ha un nome univoco all'interno dell'account di archiviazione in cui è contenuta. Le code di partizione di Azure si basano sul nome e tutti i messaggi per la stessa coda vengono archiviati nella stessa partizione, controllata da un singolo server. Code diverse possono essere gestite da server differenti per bilanciare il carico. L'allocazione di code da server è trasparente alle applicazioni e agli utenti. In un'applicazione di grandi dimensioni, non utilizzare la stessa coda di archiviazione per tutte le istanze dell'applicazione, poiché con questo approccio il server che ospita la coda potrebbe diventare un hotspot. È consigliabile utilizzare code diverse per diverse aree funzionali dell'applicazione. Le code di archiviazione di Azure non supportano le transazioni, quindi l’indirizzamento dei messaggi a code diverse dovrebbe avere un impatto minimo sulla coerenza della messaggistica.

Una coda di archiviazione di Azure è in grado di gestire fino a 2000 messaggi al secondo. Se è necessario elaborare i messaggi a una velocità maggiore, è consigliabile creare più code. In un'applicazione globale, ad esempio, è consigliabile creare le code di archiviazione separata negli account di archiviazione separata per gestire le istanze dell'applicazione in esecuzione in ogni area.

## Strategie di partizionamento per Bus di servizio di Azure

Il Bus di servizio Azure utilizza un broker messaggi per gestire i messaggi inviati a una coda del Bus di servizio o un argomento. Per impostazione predefinita, tutti i messaggi inviati a una coda o argomento vengono gestiti dallo stesso processo relativo al gestore dei messaggi. Questa architettura può inserire un limite alla velocità effettiva complessiva della coda di messaggi. Tuttavia, è anche possibile partizionare una coda o argomento quando vengono creati, impostando la proprietà _EnablePartitioning_ della descrizione della coda o argomento su _true_. Una coda o argomento partizionati sono divisi in più frammenti, ognuno dei quali è supportato da un archivio messaggi separato e dal gestore dei messaggi. Il Bus di servizio si assume la responsabilità per la creazione e la gestione di questi frammenti. Quando un'applicazione invia un messaggio a una coda o argomento partizionati, il Bus di servizio assegna il messaggio a un frammento per quella coda o quell’argomento. Quando un'applicazione riceve un messaggio da una coda o da una sottoscrizione, il Bus di servizio controlla ogni frammento per il successivo messaggio disponibile e quindi lo passa all'applicazione per l'elaborazione. Questa struttura consente di distribuire il carico tra i gestori dei messaggi e gli archivi dei messaggi, di aumentare la scalabilità e di migliorare la disponibilità. Se il gestore dei messaggi o l’archivio dei messaggi per un frammento è temporaneamente non disponibile, il Bus di servizio può recuperare i messaggi da uno dei frammenti disponibili rimanenti.

Il Bus di servizio assegna un messaggio a un frammento nel modo seguente:

- Se il messaggio appartiene a una sessione, tutti i messaggi con lo stesso valore per la proprietà \_SessionId \_ vengono inviati allo stesso frammento.
- Se il messaggio non appartiene a una sessione, ma il mittente ha specificato un valore per la proprietà _PartitionKey_, allora tutti i messaggi con lo stesso valore della _PartitionKey_sono inviati allo stesso frammento.

	> [AZURE.NOTE]Se il _SessionId_ e le proprietà della _PartitionKey_ vengono entrambi specificati, allora devono essere impostati sullo stesso valore, in caso contrario il messaggio verrà respinto.
- Se le proprietà _SessionId_ e _PartitionKey_ per un messaggio non sono specificate, ma è abilitato il rilevamento dei duplicati, verrà utilizzata la proprietà _MessageId_. Tutti i messaggi con lo stesso _MessageId_ verranno indirizzati allo stesso frammento.
- Se i messaggi non includono una proprietà _SessionId, PartitionKey,_ o _MessageId_, allora il Bus di servizio assegna i messaggi a frammenti in modo round robin. Se un frammento non è disponibile, il Bus di servizio passerà al successivo. In questo modo, un errore temporaneo nell'infrastruttura di messaggistica non determina l'esito negativo dell'operazione di invio del messaggio.

È necessario considerare i seguenti punti quando si decide (e come, o se) di partizionare luna coda di messaggi del Bus di servizio o un argomento:

- Gli argomenti e le code del Bus di servizio vengono creati nell'ambito di uno spazio dei nomi del Bus di servizio. Il Bus di servizio attualmente consente fino a 100 code o argomenti partizionati per spazio dei nomi.
- Ogni spazio dei nomi del Bus di servizio impone delle quote per le risorse disponibili, ad esempio il numero di sottoscrizioni per argomento, il numero di trasmissioni e ricezioni simultanee di richieste al secondo e il numero massimo di connessioni simultanee che possono essere stabilite. Queste quote sono documentate sul sito Web Microsoft alla pagina [Quote del bus di servizio](https://msdn.microsoft.com/library/azure/ee732538.aspx). Se si prevede di superare questi valori, è consigliabile creare ulteriori spazi dei nomi con le proprie code e argomenti e distribuire il lavoro tra questi spazi dei nomi. Ad esempio, in un'applicazione globale, è consigliabile creare spazi dei nomi separati in ogni area e configurare le istanze dell'applicazione per utilizzare le code e argomenti dello spazio dei nomi più vicino.
- I messaggi che vengono inviati come parte di una transazione devono specificare una chiave di partizione. Può trattarsi di un _SessionId, PartitionKey,_ o _MessageId_. Tutti i messaggi che vengono inviati come parte della stessa transazione devono specificare la stessa chiave di partizione perché essi devono essere gestiti dallo stesso processo del gestore dei messaggi. È possibile inviare messaggi a diverse code o argomenti all'interno della stessa transazione.
- Non è possibile configurare una coda o un argomento partizionati affinché vengano eliminati automaticamente quando diventano inattivi.
- Se si creano soluzioni multipiattaforma o ibride, è possibile attualmente utilizzare code partizionate e argomenti con il Protocollo avanzato di accodamento dei messaggi (AMQP).

## Strategie di partizionamento per Azure DocumentDB

Azure DocumentDB è un database NoSQL che può archiviare documenti. Un documento in DocumentDB è una rappresentazione serializzata JSON di un oggetto o di un altro dato. Nessuno schema fisso viene applicato ad eccezione del fatto che ogni documento deve contenere un ID univoco.

I documenti sono organizzati in raccolte. Una raccolta consente di raggruppare i documenti correlati. Ad esempio, in un sistema che gestisce il post di blog, è possibile archiviare il contenuto di ogni post di blog come un documento in una raccolta e creare raccolte per ogni tipo di oggetto. In alternativa, in un'applicazione multi-tenant, ad esempio un sistema che consente ad autori diversi di controllare e gestire i propri post, è possibile partizionare i blog per autore e creare una raccolta separata per ogni autore. Lo spazio di archiviazione allocato alle raccolte è flessibile e può ridursi o aumentare in base alle esigenze.

Le raccolte di documenti forniscono un meccanismo naturale per partizionare i dati in un unico database. Internamente, un database di DocumentDB può estendersi su più server e DocumentDB potrebbe tentare di distribuire il carico distribuendo raccolte tra server. Il modo più semplice per implementare il partizionamento orizzontale consiste nel creare una raccolta per ogni partizione.

> [AZURE.NOTE]Ogni DocumentDB viene allocato risorse in termini di un _livello di prestazioni_. A ogni livello di prestazioni è associato un limite di frequenza _dell'unità di richiesta_ (RU). Il limite di velocità RU specifica il volume delle risorse che sono riservate per la raccolta e sarà disponibile per essere utilizzato esclusivamente da tale raccolta. Il costo di una raccolta dipende dal livello di prestazioni selezionato per la raccolta; maggiore è il livello di prestazioni (e il limite di velocità RU), maggiore è l’addebito. È possibile regolare il livello di prestazioni di una raccolta utilizzando il portale di gestione di Azure. Per ulteriori informazioni, vedere la pagina [Livelli di prestazioni in DocumentDB](documentdb-performance-levels.md) sul sito Web Microsoft.

Tutti i database vengono creati nel contesto di un account di DocumentDB. Un singolo account DocumentDB può contenere più database e specifica in quale area vengono creati i database. Ogni account DocumentDB impone inoltre il proprio controllo di accesso. È possibile utilizzare account DocumentDB per individuare partizioni a livello geografico (raccolte all'interno del database) più prossime agli utenti che vi devono accedere e imporre restrizioni in modo che solo tali utenti possano connettersi a esse.

Ogni account DocumentDB dispone di una quota che limita il numero di database e raccolte che può contenere e la quantità di spazio di archiviazione dei documenti disponibile. Questi limiti sono soggetti a modifiche, descritte alla pagina [DocumentDB limiti e quote](documentdb-limits.md) sul sito Web Microsoft. In teoria, implementando un sistema in cui tutte le partizioni appartengono allo stesso database, è possibile raggiungere il limite di capacità di archiviazione dell'account. In questo caso, è necessario creare database e altri account DocumentDB e distribuire le partizioni in questi database. Tuttavia, anche se la capacità di archiviazione di un database non viene quasi mai raggiunta, un buon motivo per utilizzare più database è che ogni database ha un proprio set di utenti e autorizzazioni. È possibile utilizzare questo meccanismo per isolare l'accesso alle raccolte in base al database.

La figura 8 mostra la struttura di alto livello dell'architettura di DocumentDB.

![](media/best-practices-data-partitioning/DocumentDBStructure.png)

_Figura 8. -La struttura di DocumentDB_

È responsabilità dell'applicazione client indirizzare le richieste alla partizione appropriata, in genere mediante l'implementazione di un proprio meccanismo di mapping in base ad alcuni attributi dei dati che definiscono la chiave di partizione. La figura 9 mostra due database DocumentDB, ognuno dei quali contiene due raccolte che fungono da partizioni. I dati vengono partizionati in base all'ID tenant e contengono i dati per un tenant specifico. I database vengono creati in account DocumenDB separati che si trovano nella stessa area come i tenant che contengono i dati. La logica di routing nell'applicazione client utilizza l'ID tenant come chiave di partizione.

![](media/best-practices-data-partitioning/DocumentDBPartitions.png)

_Figura 9. -Implementazione del partizionamento orizzontale utilizzando Azure DocumentDB_

Quando si decide come partizionare i dati con DocumentDB, è necessario considerare quanto riportato di seguito:

- Le risorse disponibili per un database di DocumentDB sono soggette a limitazioni di quota dell'account DocumentDB. Ogni database può contenere un numero di raccolte (anche in questo caso, esiste un limite) e ogni raccolta è associata a un livello di prestazioni che regola il limite di velocità RU (velocità effettiva riservata) per la raccolta. Per ulteriori informazioni, visitare la pagina[DocumentDB limiti e quote](documentdb-limits.md) sul sito Web Microsoft.
- Ogni documento deve avere un attributo da utilizzare per identificare in modo univoco tale documento all'interno della raccolta in cui viene contenuto. Questo è diverso dalla chiave di partizione che definisce in quale raccolta il documento è contenuto. Una raccolta può contenere un numero elevato di documenti, in teoria limitato solo dalla lunghezza massima dell'ID di documento. L'ID di documento può contenere fino a 255 caratteri.
- Tutte le operazioni di base a un documento vengono eseguite all'interno del contesto di una transazione con ambito la raccolta in cui è contenuto il documento. Se un'operazione ha esito negativo, viene eseguito il rollback del lavoro che è stato eseguito. Quando un documento è soggetto a un'operazione, tutte le modifiche apportate sono soggette all’isolamento del livello di snapshot. Questo meccanismo garantisce che se, ad esempio, una richiesta per creare un nuovo documento ha esito negativo, un utente che contemporaneamente interrogherà il database, non visualizzerà un documento parziale che sarà rimosso.
- Le query DocumentDB inoltre sono limitate a livello di raccolta. Una singola query può recuperare dati solo da una raccolta. Se è necessario recuperare dati da più raccolte, è necessario eseguire query in ogni raccolta singolarmente e incorporare i risultati nel codice dell'applicazione.
- DocumentDB supporta elementi programmabili che possono essere archiviati in una raccolta insieme ai documenti: stored procedure, funzioni definite dall'utente e trigger (scritti in JavaScript). Questi elementi possono accedere a qualsiasi documento all'interno della stessa raccolta. Inoltre, questi elementi sono eseguibili o all'interno dell'ambito della transazione di ambiente (nel caso di un trigger che viene generato come il risultato di una creazione, eliminazione o sostituzione eseguite a fronte di un documento), o avviando una nuova transazione (nel caso di stored procedure eseguita come risultato di una richiesta client esplicita). Se il codice in un elemento programmabile genera un'eccezione, viene eseguito il rollback della transazione. È possibile utilizzare stored procedure e trigger per mantenere l'integrità e la coerenza tra i documenti, ma tutti questi documenti devono far parte della stessa raccolta.
- È necessario assicurarsi che le raccolte che si desidera mantenere nel database in un account di DocumentDB non superino i limiti di velocità effettiva definiti dai livelli di prestazioni delle raccolte. Questi limiti sono descritti alla pagina [Capacità di gestire DocumentDB](documentdb-manage.md) sul sito Web Microsoft. Se si prevede di raggiungere questi limiti, considerare la suddivisione di raccolte tra database in account DocumentDB diversi per ridurre il carico per ogni raccolta.

## Strategie di partizionamento per la Ricerca di Azure

La possibilità di eseguire la ricerca di dati è spesso il metodo principale di navigazione ed esplorazione fornito da molte applicazioni web, consentendo agli utenti di trovare rapidamente le risorse (ad esempio, i prodotti in un'applicazione di e-commerce) in base alle combinazioni di criteri di ricerca. Il servizio di ricerca di Azure offre funzionalità di ricerca full-text nel contenuto web e include funzionalità quali il suggerimento automatico di query basate su quasi corrispondenze ed esplorazione in base a facet. Una descrizione completa di queste funzionalità è disponibile alla pagina [Cenni preliminari sulla ricerca di Azure](https://msdn.microsoft.com/library/azure/dn798933.aspx) sul sito Web Microsoft.

Il servizio di ricerca memorizza il contenuto ricercabile come documenti JSON in un database . Si definiscono gli indici che specificano i campi in cui è possibile eseguire ricerche in questi documenti e forniscono le definizioni per il servizio di ricerca. Quando un utente invia una richiesta di ricerca, il servizio di ricerca utilizza gli indici appropriati per trovare gli elementi corrispondenti.

Per ridurre i conflitti, la memoria utilizzata dal servizio di ricerca può essere suddivisa in alto in 1, 2, 3, 4, 6 o 12 partizioni e ogni partizione può essere replicata fino a 6 volte. Il prodotto del numero di partizioni moltiplicato per il numero di repliche viene chiamato _Search Unit_ (SU). Una singola istanza del servizio di ricerca può contenere al massimo 36 SU (un database con 12 partizioni supporta al massimo 3 repliche). Ogni SU allocata al servizio viene fatturata. Man mano che aumenta il volume dei contenuti in cui eseguire ricerche o la frequenza di richieste di ricerca, è possibile aggiungere SU a un'istanza esistente del servizio di ricerca per gestire il carico aggiuntivo. Il servizio di ricerca si assume la responsabilità per la distribuzione di documenti in modo uniforme tra le partizioni. Attualmente non sono supportate strategie di partizionamento manuale.

Ogni partizione può contenere un massimo di 15 milioni di documenti o occupare 300 GB di spazio di archiviazione (a seconda delle dimensioni dei documenti e degli indici). È possibile creare fino a 50 indici. Le prestazioni del servizio variano a seconda della complessità dei documenti, degli indici disponibili e degli effetti della latenza di rete. In Media, una singola replica (1SU) deve essere in grado di gestire 15 query al secondo (QPS), anche se è necessario eseguire il benchmark con i propri dati per ottenere una misura della velocità effettiva più precisa. Per ulteriori informazioni, vedere la pagina [Limiti e vincoli (API di ricerca di Azure)](https://msdn.microsoft.com/library/azure/dn798934.aspx) sul sito Web Microsoft.

> [AZURE.NOTE]È possibile archiviare un set limitato di tipi di dati nei documenti in cui è possibile eseguire ricerche; stringhe, valori booleani, dati numerici, dati di tipo datetime e alcuni dati geografici. Per ulteriori informazioni, vedere la pagina [Tipi di dati supportati (ricerca di Azure)](https://msdn.microsoft.com/library/azure/dn798938.aspx) sul sito Web Microsoft.

Il controllo sulle modalità di partizione dei dati del servizio di ricerca di Azure per ogni istanza del servizio è limitato. In un ambiente globale, tuttavia, potrebbe essere in grado di migliorare le prestazioni e ridurre la latenza e i conflitti suddividendo il servizio utilizzando una delle seguenti strategie:

- Creare un'istanza del servizio di ricerca in ogni area geografica e assicurarsi che le applicazioni client vengano indirizzate verso l’istanza più vicina disponibile. Questa strategia richiede che tutti gli aggiornamenti al contenuto di ricerca siano replicati tempestivamente in tutte le istanze del servizio.
- Creare due livelli di servizio di ricerca: un servizio locale in ogni area che contiene i dati più accessibili agli utenti in tale area e un servizio globale che include tutti i dati. Gli utenti possono indirizzare le richieste al servizio locale (per ottenere risultati veloci ma limitati) o al servizio globale (per ottenere risultati più lenti, ma più completi). Questo approccio è più adatto quando esiste una variazione regionale significativa nei dati da cercare.

## Strategie di partizionamento per Cache Redis di Azure

Cache Redis di Azure fornisce un servizio di memorizzazione nella cache condiviso nel cloud basato sull'archivio dati Redis chiave/valore. Come suggerisce il nome, la Cache Redis di Azure costituisce una soluzione di memorizzazione nella cache e pertanto deve essere utilizzata solo per contenere i dati temporanei e non come archivio dati permanente; le applicazioni che utilizzano la Cache Redis di Azure devono essere in grado di continuare a funzionare se la cache non è disponibile. Cache Redis di Azure supporta la replica primaria o secondaria per garantire un'elevata disponibilità, ma attualmente limita la dimensione massima della cache a 53 GB. Se è necessario più spazio, si devono creare cache aggiuntive. Per ulteriori informazioni visitare la pagina [Cache di Microsoft Azure](http://azure.microsoft.com/services/cache/) sul sito Web Microsoft.

Il partizionamento di un archivio dati Redis prevede la suddivisione dei dati tra istanze del servizio Redis. Ogni istanza rappresenta una singola partizione. Cache Redis di Azure consente di astrarre i servizi di Redis dietro un’interfaccia e non li espone direttamente. Il modo più semplice per implementare il partizionamento consiste nel creare più cache Redis di Azure e distribuire i dati su di esse. È possibile associare ogni elemento di dati con un identificatore (chiave di partizione) che specifica in quale tipo di cache devono essere archiviati. La logica dell'applicazione client può utilizzare questo identificatore per indirizzare le richieste alla partizione appropriata. Se lo schema di partizionamento viene modificato (se vengono create ulteriori Cache Redis di Azure, ad esempio), potrebbe essere necessario riconfigurare le applicazioni client.

Redis nativo (non Cache Redis di Azure) supporta il partizionamento sul lato server basato sul clustering di Redis. In questo approccio, i dati sono divisi uniformemente tra i server utilizzando un meccanismo di hash. Ogni server Redis archivia i metadati che descrivono l’intervallo delle chiavi di hash che la partizione contiene e contiene inoltre informazioni su quali chiavi di hash si trovano nelle partizioni su altri server. Le applicazioni client inviano semplicemente richieste a qualsiasi server che partecipi a Redis (probabilmente il server più vicino). Il server Redis esamina la richiesta del client e se possa essere risolta in locale esegue l'operazione richiesta, in caso contrario inoltra la richiesta al server appropriato. Questo modello viene implementato dal clustering Redis e viene descritto più dettagliatamente alla pagina [Esercitazione del cluster Redis](http://redis.io/topics/cluster-tutorial) sul sito Web Redis. Il clustering di Redis è trasparente alle applicazioni client e gli ulteriori server Redis possono essere aggiunti al cluster (e i dati partizionati nuovamente) senza dover riconfigurare i client.

> [AZURE.IMPORTANT]La Cache Redis di Azure non supporta attualmente il clustering. Se si desidera implementare questo approccio con Azure, è necessario implementare i propri server Redis installando Redis in un set di macchine virtuali di Azure e configurarle manualmente. La pagina [Esecuzione Redis in una macchina virtuale CentOS Linux in Azure](http://blogs.msdn.com/b/tconte/archive/2012/06/08/running-redis-on-a-centos-linux-vm-in-windows-azure.aspx) sul sito Web Microsoft illustra un esempio che mostra come creare e configurare un nodo Redis in esecuzione come una macchina virtuale di Azure.

La pagina [Partizionamento: come suddividere i dati tra più istanze di Redis](http://redis.io/topics/partitioning) sul sito Web Redis fornisce ulteriori informazioni sull'implementazione del partizionamento con Redis. Il resto di questa sezione presuppone l'implementazione di partizionamento sul lato client o assistito dal proxy.

Quando si decide come partizionare i dati con Cache Redis di Azure, è necessario considerare quanto riportato di seguito:

- Cache Redis di Azure non può fungere da archivio dati permanente, pertanto qualsiasi schema di partizionamento si implementi, il codice dell'applicazione deve essere preparato ad accettare che i dati non sono stati trovati nella cache e deve essere recuperato da un'altra posizione.
- Mantieni i dati utilizzati di frequente nella stessa partizione. Redis è un potente archivio di chiavi/valori che fornisce diversi meccanismi altamente ottimizzati per la strutturazione dei dati, che vanno da semplici stringhe (dati binari fino a 512 MB di lunghezza) ai tipi di aggregati come gli elenchi (che possono fungere da code e stack), set ( ordinati e non ordinati) e hash (che possono raggruppare campi correlati come gli elementi che rappresentano i campi in un oggetto). I tipi di aggregati consentono di associare molti valori correlati con la stessa chiave. Una chiave Redis identifica un elenco, set, o hash anziché gli elementi dei dati in essa contenuti. Questi tipi sono tutti disponibili con Cache Redis di Azure e sono descritti alla pagina [Tipi di dati](http://redis.io/topics/data-types) sul sito Web di Redis. Ad esempio, in parte di un sistema di e-commerce che tiene traccia degli ordini effettuati dai clienti, i dettagli di ogni cliente possono essere archiviati in un hash Redis con chiave utilizzando l'ID cliente. Ogni hash può contenere un insieme di ID degli ordini del cliente. Un set separato di Redis può contenere gli ordini nuovamente strutturati come hash, con la chiave, utilizzando l'ID dell'ordine. Nella figura 10 viene illustrata questa struttura. Si noti che Redis non implementa alcuna forma di integrità referenziale, pertanto è responsabilità dello sviluppatore mantenere le relazioni tra clienti e ordini.

![](media/best-practices-data-partitioning/RedisCustomersandOrders.png)

_Figura 10. -Struttura consigliata nel servizio di archiviazione per la registrazione degli ordini dei clienti e i relativi dettagli Redis_

> [AZURE.NOTE]In Redis, tutte le chiavi sono i valori di dati binari (come stringhe Redis) e possono contenere fino a 512 MB di dati: in teoria una chiave può contenere quasi tutte le informazioni. Tuttavia, è consigliabile adottare una convenzione di denominazione coerente per le chiavi, che descrive il tipo di dati e che identifica l'entità, ma che non è eccessivamente lunga. Un approccio comune consiste nell'utilizzare chiavi nel formato "entity\_type:ID", ad esempio "cliente: 99" per indicare la chiave per il cliente con ID 99.

- È possibile implementare il partizionamento verticale archiviando le informazioni correlate in aggregazioni diverse nello stesso database. Ad esempio, in un’applicazione e-commerce è possibile archiviare informazioni sui prodotti maggiormente utilizzati in un hash di Redis e le informazioni dettagliate utilizzate meno frequentemente in un altro. Entrambi gli hash potrebbero utilizzare lo stesso ID di prodotto come parte della chiave, ad esempio "prodotto:_nn_" dove _nn_ è l'ID di prodotto per informazioni sul prodotto e "product\_details: _nn_" per i dati dettagliati. Questa strategia può contribuire a ridurre il volume dei dati che possono recuperare la maggior parte delle query.
- Ripartizionare un archivio dati Redis è un'attività lunga e complessa. I clustering redis possono ripartizionare dati automaticamente, ma questa funzionalità non è disponibile con Cache Redis di Azure. Pertanto, quando si progetta lo schema di partizione, è opportuno cercare di lasciare sufficiente spazio libero in ogni partizione per consentire la crescita dei dati previsti nel tempo. Tuttavia, tenere presente che Cache Redis di Azure consente di memorizzare dati temporaneamente e che i dati contenuti nella cache possono avere una durata limitata, specificata come valore time-to-live (TTL). Per i dati volatili la durata TTL deve essere più breve, ma per i dati statici la durata TTL può essere molto più lunga. È consigliabile evitare di archiviare grandi quantità di dati di lunga durata nella cache, se il volume dei dati deve riempire la cache. È possibile specificare un criterio di rimozione che spinge la Cache Redis di Azure a rimuovere i dati se lo spazio è prezioso.

	> [AZURE.NOTE]Cache Redis di Azure consente di specificare le dimensioni massime della cache (da 250 MB a 53 GB) selezionando la fascia di prezzo appropriato. Tuttavia, dopo aver creata una Cache Redis di Azure, è possibile aumentare (o diminuire) le dimensioni.

- Batch di redis e le transazioni non possono estendersi su più connessioni, in modo che tutti i dati interessati da un batch o una transazione devono essere mantenuti nello stesso database (partizione).

	> [AZURE.NOTE]Una sequenza di operazioni in una transazione di Redis non è necessariamente atomica. I comandi che costituiscono una transazione vengono verificati e messi in coda prima dell'esecuzione e se si verifica un errore durante questa fase l’intera coda viene eliminata. Tuttavia, dopo che la transazione è stata inviata correttamente, i comandi in coda verranno eseguiti in sequenza. Se un comando ha esito negativo solo tale comando viene interrotto; è possibile eseguire tutti i comandi precedenti e successivi nella coda. Se è necessario eseguire operazioni atomiche. Per ulteriori informazioni, visitare la pagina relativa alle [Transazioni](http://redis.io/topics/transactions) sul relativo sito Web.

- Redis supporta un numero limitato di operazioni atomiche e le uniche operazioni di questo tipo che supportano più valori e chiavi sono MGET (che restituisce una raccolta di valori per un elenco di chiavi specificato) e MSET (che consente di archiviare un insieme di valori per un elenco di chiavi specificato). Se è necessario utilizzare queste operazioni, le coppie chiave/valore a cui fanno riferimento i comandi MSET e MGET devono essere archiviate nello stesso database.

## Ribilanciamento delle partizioni

Come un sistema matura e il modello di utilizzo diventa più chiaro, è possibile che sia necessario modificare lo schema di partizionamento. Ciò potrebbe dipendere da singole partizioni che attirano una quantità sproporzionata di volume di traffico e diventano critiche, causando conflitti eccessivi. Inoltre, si potrebbe aver sottostimato il volume dei dati in alcune partizioni, causando l’avvicinamento ai limiti della capacità di archiviazione in queste partizioni. Indipendentemente dall'origine, talvolta è necessario ribilanciare le partizioni per ripartire il carico in modo più uniforme.

In alcuni casi, i sistemi di archiviazione di dati che non espongano pubblicamente il modo in cui i dati sono allocati ai server possono ribilanciare automaticamente le partizioni entro i limiti delle risorse disponibili. In altri casi, il ribilanciamento è un'attività amministrativa costituita da due fasi:

1. Determinazione della nuova strategia di partizionamento per determinare quali partizioni potrebbero essere suddivise (o eventualmente combinate) e come allocare i dati a queste nuove partizioni progettando nuove chiavi di partizione.
2. La migrazione dei dati interessati dallo schema di partizionamento precedente al nuovo set di partizioni.

> [AZURE.NOTE]Il mapping di raccolte di DocumentDB ai server è trasparente, ma potrebbe ancora raggiungere i limiti di capacità di archiviazione e velocità effettiva di un account di DocumentDB. In questo caso è necessario progettare nuovamente lo schema di partizione e migrare i dati.

A seconda della tecnologia di archiviazione dati e della progettazione del sistema di archiviazione dati, è possibile eseguire la migrazione di dati tra partizioni mentre sono in uso (migrazione online). In caso contrario, potrebbe essere necessario effettuare partizioni interessate temporaneamente non disponibili, mentre i dati vengono spostati (migrazione offline).

## Migrazione offline

La migrazione offline è probabilmente l'approccio più semplice in quanto riduce le probabilità che si verifichino conflitti; i dati in fase di migrazione non devono essere modificati mentre vengono spostati e ristrutturati.

Concettualmente, questo processo comprende i passaggi seguenti:

1. Contrassegnare la partizione non in linea,
2. Divisione/unione e spostamento dei dati alle nuove partizioni,
3. Verificare i dati,
4. Portare in linea le nuove partizioni,
5. Rimuovere la partizione precedente.

Per mantenere una disponibilità, è possibile contrassegnare la partizione originale come di sola lettura nel passaggio 1 anziché renderla non disponibile. Questo consentirebbe alle applicazioni di leggere i dati mentre vengono spostati ma non di modificarli.

## Migrazione online

La migrazione online è più complesso da eseguire, ma è meno problematica per gli utenti poiché i dati rimangono disponibili durante l'intera procedura. Il processo è simile a quella utilizzato dalla migrazione offline, ad eccezione del fatto che la partizione originale non è contrassegnata come non in linea (passaggio 1). A seconda della granularità del processo di migrazione (per elemento o partizione), il codice di accesso ai dati nelle applicazioni client potrebbe dover gestire la lettura e scrittura dei dati contenuti in due posizioni (partizione originale e nuova partizione)

Per un esempio di una soluzione che supporta la migrazione online, vedere il documento online[Servizio divisione/unione per la scala elastica](sql-database-elastic-scale-overview-split-and-merge.md), sul sito Web Microsoft.

## Modelli correlati e informazioni aggiuntive

I modelli seguenti possono essere rilevanti per il proprio scenario anche quando si considerano strategie per l'implementazione di coerenza dei dati:

- La pagina Indicazioni di coerenza di dati, disponibile sul sito Web Microsoft, descrive le strategie per la gestione della coerenza in un ambiente distribuito, ad esempio il cloud.
- La pagina[Indicazioni di partizionamento dati](https://msdn.microsoft.com/library/dn589795.aspx) sul sito Web Microsoft fornisce una panoramica generale di progettazione di partizioni per soddisfare diversi criteri in una soluzione distribuita.
- Il [Modello di partizionamento orizzontale](https://msdn.microsoft.com/library/dn589797.aspx), descritto nel sito Web Microsoft, riepiloga alcune strategie comuni per i dati di partizionamento orizzontale.
- [Index Table Pattern](https://msdn.microsoft.com/library/dn589791.aspx) descritto sul sito Web Microsoft viene illustra come creare gli indici secondari sui dati. Questo approccio consente a un'applicazione di recuperare rapidamente i dati utilizzando le query che non fanno riferimento alla chiave primaria di una raccolta.
- [Materialized View Pattern](https://msdn.microsoft.com/library/dn589782.aspx) descritto sul sito Web Microsoft descrive come generare visualizzazioni preinserite che riepilogano i dati per supportare velocemente le operazioni di query. Questo approccio può essere utile in un archivio dati partizionati se le partizioni che contengono dati riepilogati vengono distribuite tra più siti.
- L’articolo Rete per la distribuzione di contenuti (CDN) fornisce ulteriori informazioni sulla configurazione e sull’utilizzo della rete CDN con Azure.

## Altre informazioni

- La pagina [Database SQL di Azure](https://msdn.microsoft.com/library/azure/ee336279.aspx) sul sito Web Microsoft fornisce informazioni dettagliate sulla descrizione e l’utilizzo di database SQL.
- La pagina [Informazioni generali sulla scalabilità elastica del database SQL di Azure](sql-database-elastic-scale-introduction.md) sul sito Web Microsoft fornisce un'introduzione più completa sulla scalabilità elastica.
- L'argomento [suddivisione e unione con una certa flessibilità](sql-database-elastic-scale-overview-split-and-merge.md) sul sito Web Microsoft contiene informazioni sull'utilizzo del servizio di suddivisione/unione per gestire partizioni con scalabilità elastica.
- La pagina [Obiettivi di scalabilità e prestazioni per Archiviazione di Azure](https://msdn.microsoft.com/library/azure/dn249410.aspx) sul sito Web Microsoft documenta gli attuali limiti di ridimensionamento e la velocità effettiva di archiviazione di Azure.
- La pagina[Esecuzione di transazioni del gruppo di entità](https://msdn.microsoft.com/library/azure/dd894038.aspx) del sito Web Microsoft fornisce informazioni dettagliate sull'implementazione di operazioni transazionali su entità archiviate in archiviazione tabelle di Azure.
- L'articolo [Progettazione di una strategia di partizionamento scalabile per l'archiviazione tabelle di Azure](https://msdn.microsoft.com/library/azure/hh508997.aspx) su Microsoft sito Web contiene informazioni dettagliate sul partizionamento dei dati nell'archiviazione tabelle di Azure.
- La pagina [Uso della rete CDN per Azure](cdn-how-to-use.md) sul sito Web Microsoft illustra come replicare dati in archiviazione Blob di Azure tramite la rete per la distribuzione di contenuti (rete CDN).
- La pagina [Limiti per la versione di anteprima di DocumentDB](documentdb-limits.md) sul sito Web Microsoft descrive le quote e i limiti attuali per Microsoft DocumentDB.
- La pagina [Gestire la capacità e le prestazioni di DocumentDB ](documentdb-manage.md) sul sito Web Microsoft contiene informazioni su come DocumentDB Azure alloca le risorse ai database.
- La pagina [Cenni preliminari sulla ricerca di Azure](https://msdn.microsoft.com/library/azure/dn798933.aspx) sul sito Web Microsoft fornisce una descrizione completa delle funzionalità disponibili con il servizio di ricerca di Azure.
- La pagina[limiti e i vincoli (API di ricerca di Azure)](https://msdn.microsoft.com/library/azure/dn798934.aspx) sul sito Web Microsoft contiene informazioni sulla capacità di ogni istanza del servizio di ricerca di Azure.
- La pagina [Tipi di dati supportati (ricerca di Azure)](https://msdn.microsoft.com/library/azure/dn798938.aspx) sul sito Web Microsoft riepiloga i tipi di dati che è possibile utilizzare nei documenti e indici in cui è possibile eseguire ricerche.
- La pagina [Cache di Microsoft Azure](http://azure.microsoft.com/services/cache.md) sul sito Web Microsoft fornisce un'introduzione a Cache Redis di Azure.
- La pagina [Partizionamento: come suddividere i dati tra più istanze di Redis](http://redis.io/topics/partitioning) sul sito Web Redis fornisce informazioni sull'implementazione del partizionamento con Redis.
- La pagina [Esecuzione Redis in una macchina virtuale CentOS Linux in Azure](http://blogs.msdn.com/b/tconte/archive/2012/06/08/running-redis-on-a-centos-linux-vm-in-windows-azure.aspx) sul sito Web Microsoft illustra un esempio che mostra come creare e configurare un nodo Redis in esecuzione come una macchina virtuale di Azure.
- La pagina [Tipi di dati](http://redis.io/topics/data-types) sul sito Web di Redis descrive i tipi di dati che sono disponibili con Redis e Cache Redis di Azure.

<!---HONumber=Oct15_HO3-->